#!/bin/sh
showClassMenu() {
  classMenu=""
  i=1
  while read line;
    do
      classMenu=$classMenu"$i $line "
      i=$(($i+1))
    done < InitialClassData/classOnOff.txt
  chooseNum=`dialog --stdout --buildlist "Course Regestration System" 100 200 40 $classMenu`
  choose=$?
  echo $chooseNum | awk -F " " '{for(i=1; i<=NF; i++) print $i > "ChooseClassData/chooseNum.txt" }'
  echo $choose
  if [ $choose = "0" ];
  then
    classMenuOkButton
  else
    classMenuExitButton
  fi
}

classMenuOkButton() {
  storeChooseClass
  updateClassList
  checkCollision
  if [ -e ChooseClassData/collision.txt ];
  then
    # cp ClassList/resetClassList.txt ClassList/tmpClassList.txt
    currentState="Collision"
  else
    insertNewClass
    updateClassOnOff
    splitNameClassList
    insertClassToTable
    # cp ClassList/resetClassList.txt ClassList/tmpClassList.txt
    currentState="ClassTable"
  fi
}

classMenuExitButton() {
  currentState="Exit"
}

storeChooseClass() {
  rm -f ChooseClassData/chooseClassName.txt
  rm -f ChooseClassData/chooseClassTime.txt
  while read line;
  do
    awk NR==$line InitialClassData/cosEName.txt >> "ChooseClassData/chooseClassName.txt"
    awk NR==$line InitialClassData/cosTime.txt >> "ChooseClassData/chooseClassTime.txt"
  done < ChooseClassData/chooseNum.txt
}

updateClassList() {
  currentRow=1;
  while read timeRow;
  do
    echo $timeRow |
        awk '{
          split ($0, timeArray, "");
          currentDay = "";
          for (i=1; i <= length($0); i++) {
              if (timeArray[i]~/[0-9]/) {
                currentDay = timeArray[i];
              }
              if (timeArray[i]~/[A-Z]/) {
                currentClass = timeArray[i];
                separateTime = currentDay currentClass;
                printf "%s\n", separateTime > "ChooseClassData/modifyClassTime.txt"
              }
          }
        }'
    rm -f ChooseClassData/tmpClass.txt
    awk NR==$currentRow ChooseClassData/chooseClassName.txt > "ChooseClassData/tmpClass.txt"
    insertClassList
    currentRow=$((currentRow+1))
  done < ChooseClassData/chooseClassTime.txt
}

insertClassList() {
  createClassBuffer
  mergeBufferToTmpClassList
}

createClassBuffer() {
  fillTmpBuffer
  appendTimeToBuffer
}

fillTmpBuffer() {
  rm -f ChooseClassData/tmpClassBuffer.txt
  while read time;
    do
      awk NR==1 ChooseClassData/tmpClass.txt >> "ChooseClassData/tmpClassBuffer.txt"
    done < ChooseClassData/modifyClassTime.txt
}

appendTimeToBuffer() {
  rm -f ChooseClassData/classBuffer.txt
  paste -d " "  ChooseClassData/modifyClassTime.txt ChooseClassData/tmpClassBuffer.txt > ChooseClassData/classBuffer.txt
}

mergeBufferToTmpClassList() {
  sort ChooseClassData/classBuffer.txt | join -a 1 ClassList/tmpClassList.txt - | awk '{print $0 > "ClassList/tmpClassList.txt"}'
}


checkCollision() {
  rm -f ChooseClassData/collision.txt
  while read listRow;
    do
      echo $listRow | awk -F " " '{if(NF >= 3){print $0 >> "ChooseClassData/collision.txt"}}'
    done < CLassList/tmpClassList.txt
}

insertNewClass() {
  rm -f ClassList/newClassList.txt
  while read listRow;
    do
      echo $listRow | awk -F " " '{if(NF == 2){print $0 >> "ClassList/newClassList.txt"}}'
    done < ClassList/tmpClassList.txt
  if [ -e  ClassList/newClassList.txt ]
    then
      sort  ClassList/newClassList.txt | join -a 1  ClassList/classList.txt - | awk '{print $0 > "ClassList/classList.txt"}'
    fi
}

updateClassOnOff() {
  while read num;
    do
      sed -i.bak "$num s/off/on/g" InitialClassData/classOnOff.txt
    done < ChooseClassData/chooseNum.txt
}

splitNameClassList() {
  rm -f ClassList/splitNameClassList.txt
  while read classRow;
    do
      echo $classRow |
        awk 'BEGIN {ORS=" "} {
          print substr( $0, 1, 3) >> "ClassList/splitNameClassList.txt"
          for (i=4;i<=length($0);i+=13) {
            print substr( $0, i, 13) >> "ClassList/splitNameClassList.txt"
          }
            printf"\n" >> "ClassList/splitNameClassList.txt"
        }'
    done < ClassList/classList.txt
}

insertClassToTable() {
  sh insertClassToTable.sh
}

showCollisionMessage() {
  collisionMessage=`cat ChooseClassData/collision.txt`
  dialog --title "Class Collision, Please Choose Again!" --msgbox "$collisionMessage" 100 100
  choose=$?
  if [ $choose = "0" ]
    then
      collisionOkButton
    fi
}

collisionOkButton() {
  currentState="ClassMenu"
}

currentState="ClassMenu"
showClassTable() {
  dialog --backtitle "class table" --ok-label "add class" --extra-button --extra-label "options" --help-button --help-label "exit" --textbox table.txt 100 100
  choose=$?
  if [ $choose="0" ]
    then
      tableAddClassButton
    fi
}

tableAddClassButton() {
  currentState="ClassMenu"
}

showClassMenu

#while true
#  do
#    if [ $currentState = "ClassMenu" ]
#   then
#      showClassMenu
#    elif [ $currentState = "Collision" ]
#    then
#      showCollisionMessage
#    elif [ $currentState = "ClassTable" ]
#    then
#      showClassTable
#    elif [ $currentState = "Exit" ]
#   then
#      break
#    fi
#  done

